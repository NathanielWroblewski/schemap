#!/usr/bin/env ruby
require 'active_record'
require 'pg'
require 'pry'

ENV['RAILS_ENV'] = ARGV[0] || 'production'
DIR = File.open("#{Dir.pwd}/config/environment.rb")
require DIR

db_config = YAML.load_file("#{Dir.pwd}/config/database.yml")
ActiveRecord::Base.establish_connection db_config['development']
db = ActiveRecord::Base.connection
schema = db.tables[1..-1].map do |table|
  {table =>
    {attributes:
      (db.columns(table).map(&:name)),
      associations:
        table.classify.constantize.reflections.map { |r|
        r[1].table_name
      }
    }
  }
end

File.open('temp.json','w') do |file|
  file << schema.to_json
end

html = File.expand_path('../../lib/schemap/schemap.html', __FILE__)
`open #{html}`
